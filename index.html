<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Feierabend‚ÄëTimer</title>
<style>
    body { font-family: system-ui, sans-serif; background: #f4f7fa; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; }
    .container { background: #fff; padding: 24px 32px; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,.08); width: 360px; }
    h2 { margin-top: 0; color: #2c82c9; text-align: center; }
    #today { margin-bottom: 12px; text-align: center; font-weight: 600; }
    input[type="time"] { width: 100%; padding: 8px 12px; font-size: 16px; border: 1px solid #d0d4da; border-radius: 6px; }
    button { margin-top: 10px; width: 100%; padding: 8px; background: #2c82c9; color: #fff; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
    button + button { background: #4078a7; }
    .output, .summary { margin-top: 12px; font-size: 14px; }
    .highlight { font-weight: bold; }
</style>
</head>
<body>
    <div class="container">
        <h2>üïî Feierabend‚ÄëTimer</h2>
        <div id="today"></div>
        <input type="time" id="startTime" />
        <button id="startBtn">Start</button>
        <button id="addBtn">Stunden nachtragen</button>
        <div class="output" id="output"></div>
        <div class="summary" id="monthly"></div>
    </div>

<script>
(function () {
    "use strict";
    const MS_PER_MIN = 60 * 1000;
    const WORKDAY_MINUTES = 8 * 60;

    const $ = (id) => document.getElementById(id);

    const startBtn = $("startBtn");
    const addBtn = $("addBtn");
    const todayEl = $("today");
    const outputEl = $("output");
    const monthlyEl = $("monthly");
    let intervalId = null;

    // ----- Init -----
    todayEl.textContent = new Date().toLocaleDateString("de-DE", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
    });

    startBtn.addEventListener("click", startTimer);
    addBtn.addEventListener("click", addPastHours);
    updateMonthlyOverview();

    // ----- Timer -----
    function startTimer() {
        if (intervalId) clearInterval(intervalId);

        const startStr = $("startTime").value;
        if (!startStr) return alert("Bitte Startzeit eingeben.");

        // Save and start
        saveWorkday(startStr);
        renderTimer(startStr);
        intervalId = setInterval(() => renderTimer(startStr), 1000);
    }

    function renderTimer(startStr) {
        const minutesWorked = calculateWorkMinutesToday(startStr);
        const minutesLeft = WORKDAY_MINUTES - minutesWorked;

        const target = timeStringToDate(startStr);
        target.setMinutes(target.getMinutes() + WORKDAY_MINUTES);

        const leftStr = formatMinutes(minutesLeft);
        const feierabend = target.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });

        outputEl.innerHTML = `
            Gearbeitet: <span class="highlight">${formatMinutes(minutesWorked)}</span> ‚Äì 
            Verbleibend: <span class="highlight">${leftStr}</span><br>
            ‚è∞ Feierabend um <span class="highlight">${feierabend}</span>
        `;

        if (minutesLeft <= 0) {
            clearInterval(intervalId);
            outputEl.innerHTML += "<br><b>üéâ Feierabend! Gute Erholung.</b>";
        }
        updateMonthlyOverview();
    }

    // ----- Helpers -----
    function calculateWorkMinutesToday(startStr) {
        if (!startStr) return 0;
        const start = timeStringToDate(startStr);
        const diffMs = Date.now() - start.getTime();
        return Math.max(0, Math.min(WORKDAY_MINUTES, Math.floor(diffMs / MS_PER_MIN)));
    }

    function timeStringToDate(timeStr) {
        // "HH:MM" => Date today with that time in local TZ
        const [h, m] = timeStr.split(":").map(Number);
        const d = new Date();
        d.setHours(h, m, 0, 0);
        return d;
    }

    function formatMinutes(min) {
        const h = Math.floor(Math.abs(min) / 60).toString().padStart(2, "0");
        const m = Math.abs(min) % 60;
        return `${h}:${m.toString().padStart(2, "0")} h`;
    }

    // ----- Persistence -----
    function saveWorkday(startStr) {
        const key = (new Date()).toISOString().slice(0, 10); // YYYY-MM-DD
        const data = JSON.parse(localStorage.getItem("workdays") || "{}");
        data[key] = startStr;
        localStorage.setItem("workdays", JSON.stringify(data));
    }

    // ----- Monthly overview -----
    function updateMonthlyOverview() {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth(); // 0‚Äëbased
        const totalDays = new Date(y, m + 1, 0).getDate();

        // Workdays in month
        let workdays = 0;
        for (let d = 1; d <= totalDays; d++) {
            const weekday = new Date(y, m, d).getDay();
            if (weekday >= 1 && weekday <= 5) workdays++;
        }
        const soll = workdays * WORKDAY_MINUTES;

        // Ist
        let ist = 0;
        const saved = JSON.parse(localStorage.getItem("workdays") || "{}");
        for (const date in saved) {
            if (date.startsWith(`${y}-${String(m + 1).padStart(2, "0")}`)) {
                if (date < now.toISOString().slice(0, 10)) {
                    ist += WORKDAY_MINUTES; // volle 8h f√ºr vergangene Tage
                } else {
                    ist += calculateWorkMinutesToday(saved[date]); // aktueller Tag live
                }
            }
        }
        const extras = JSON.parse(localStorage.getItem("pastHours") || "{}");
        for (const date in extras) {
            if (date.startsWith(`${y}-${String(m + 1).padStart(2, "0")}`)) {
                ist += extras[date];
            }
        }

        const saldo = ist - soll;
        const saldoStr = `${saldo >= 0 ? "+" : "‚Äì"}${formatMinutes(Math.abs(saldo)).replace(" h", "")}`;

        monthlyEl.innerHTML = `
            üìÖ ${now.toLocaleDateString("de-DE", { month: "long", year: "numeric" })}<br>
            Soll: <b>${formatMinutes(soll)}</b> ‚Äì 
            Ist: <b>${formatMinutes(ist)}</b><br>
            Saldo: <b>${saldoStr}</b> ${saldo > 0 ? "‚ùå √úber Soll" : "‚úÖ Im Limit"}
        `;
    }

    // ----- Past hours -----
    function addPastHours() {
        const date = prompt("Datum (YYYY‚ÄëMM‚ÄëDD):");
        if (!date || !/^\d{4}-\d{2}-\d{2}$/.test(date)) return;

        const hours = prompt("Gearbeitete Stunden (HH:MM):");
        if (!hours || !/^\d{1,2}:\d{2}$/.test(hours)) return;

        const [h, m] = hours.split(":").map(Number);
        const minutes = h * 60 + m;
        const data = JSON.parse(localStorage.getItem("pastHours") || "{}");
        data[date] = minutes;
        localStorage.setItem("pastHours", JSON.stringify(data));
        updateMonthlyOverview();
    }
})();
</script>
</body>
</html>
